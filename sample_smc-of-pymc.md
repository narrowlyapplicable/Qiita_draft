# [PyMC]多峰事後分布のためのsample_smc (Sequential Monte Carlo Sampler)

# Intro
この記事では、ベイズ推定用ライブラリ[PyMC](https://www.pymc.io/welcome.html)にあるMCMC実装の一種、[`sample_smc`](https://www.pymc.io/projects/docs/en/latest/api/generated/pymc.smc.sample_smc.html)について扱います。

MCMCによるベイズ推論は、多峰な事後分布形状に弱いという弱点があります。
単純な例として、やや離れた正規分布×2からMCMCでサンプリングしてみましょう。下図は、MCMCのデファクトスタンダードであるNUTS (No U-Turn Sampler) による結果です。
![多峰分布からのサンプリング例](./graph/SMC図1_replica-exchange.png)
左側の正規分布から移動できず、右側の正規分布からはサンプリングできていないことがわかります。これは、2つのmode（事後確率の高い領域）の間に谷があり、MCMCサンプラーがこの谷を乗り越えられないことに起因します。
古典的な統計の範疇では、こうした多峰な事後分布に遭遇する機会は稀でした。しかしベイズ統計モデリングは柔軟性が高く、複雑なモデルでもベイズ信頼区間・予測区間を得て、統計的な意思決定が可能です。そのため扱う事後分布も複雑さを増しており、多峰事後分布による問題は避けては通れないものになりつつあります。

この問題に対処する代表的な方法として、レプリカ交換法があります。

- [RStanによる実装例 (StatModeling Memorandum)](https://statmodeling.hatenablog.com/entry/stan-parallel-tempering)
- [BDA3](https://www.amazon.co.jp/dp/1439840954/)・[渡辺ベイズ本](https://www.amazon.co.jp/dp/4339024627/)・[計算統計Ⅱ](https://www.amazon.co.jp/dp/B078WSTYC7/)などにも説明あり

しかしレプリカ交換法を使おうとすると、実用上の困難がいくつかあります。以下は私見ですが、

- 複数のchain（独立したMCMC試行）を並列実行して、そのうち1つのchainだけが結果となるため、効率が良くない。
- パラメータ（後述する逆温度の配置間隔）が難しく、問題ごとに手動で調整する必要がある。
  - 逆温度の配置間隔が開き過ぎていると、多峰分布の峰(mode)間の移動に失敗しやすい。実用上は真の事後分布形状が未知であることが多いため、うまく調整することは困難になりがち。
  - 配置感覚の経験則が知られているが、実際にはうまく行かないことが多い。
- 主要ライブラリには実装がなく、自力で実装する必要がある。
  - tensorflow probabilityには実装がありますが、NUTSが使えないためステップ幅を決め打ちする必要がある等、使い勝手はあまりよくない。

レプリカ交換を代替し得る手法として、パーティクルフィルタに用いる逐次モンテカルロ (Sequential Monte Carlo) 法を応用した手法が使われ始めています。
この手法の名前（と手法の細部）は分野によって微妙に異なるようですが、ここではPyMCに実装されている`sample_smc`に注目し、名前もこれに倣ってSMCと呼ぶことにします。

#　1. ベイズ推論における逆温度パラメータ

## 1.1. 逆温度の導入
まず、通常のベイズ推論をおさらいしておきます。
データ $X^{(n)}=\{x_n\}_{n=1}^N$ にモデル $p(x|\theta)$ を仮定し、そのパラメータ $\theta$ に事前分布 $p(\theta)$ を仮定したとき、パラメータ $\theta$ の事後分布は

```math
p(\theta | X^{(n)}) := \frac{p(\theta) \prod_{n=1}^N p(x_n|\theta)}{Z_n(X^{(n)})}
```

となります。右辺分母の$Z_n(X^{(n)})$は、確率の総和が1になるようにする正規化定数です。

ここで事後分布をより一般に拡張し、逆温度$\beta$の事後分布

```math
p^{\beta}(\theta | X^{(n)}) := \frac{p(\theta) \prod_{n=1}^N p(x_n|\theta)^{\beta}}{Z_n(X^{(n)})}
```

を導入します。通常の事後分布との違いは、**尤度が$\beta$乗されている**という1点だけです。

直感的には、逆温度$\beta$は尤度と事前分布のバランスを制御するパラメータと言えます。
事後確率最大化法（MAP推定）を行う場合、事前分布は正規化に相当しますから、逆温度は正規化の強さを制御するパラメータとみなすことができます。
この解釈については、[カイヤンさんのブログ記事]()で詳しく紹介されていますので、ピンと来ない場合はこちらを参照してください。

## 1.2. 逆温度によるMCMCの改善

### 1.2.1. 事後分布形状への影響

事前分布が一様、あるいは極めて弱い弱情報事前分布であった場合を考えてみます。
その場合、事前分布による正規化の効果は殆どあるいは全くありませんから、逆温度$\beta$は尤度（そして事後分布）の形状を直接的に変動させるパラメータと見做せることになります。

[図：βによる尤度の変化]

図はβを1から小さくしていった例を示しています。
$0<\beta<1$ の範囲で $\beta$ を小さくしていけば、尤度は平坦になっていきます。事前分布がほぼ平坦であれば、事後分布も同様です。

この性質を利用して、MCMCを改善することができます。
Introで述べた通り、MCMCは多峰分布からのサンプリングを苦手としています。そこで逆温度を$0<\beta<1$ に設定し、事後分布を平坦にすれば、この問題はある程度緩和できます。極論$\beta=0$ としてしまえば、尤度は完全に定数になり、サンプリングも容易になります。

ただし最終的に求めたいのは $\beta=1$ での事後分布ですから、逆温度を小さくするだけでは不足です。逆温度をMCMCと並行して変更したり、複数の逆温度設定でMCMCを並行させたりといった操作が必要になります。こうした逆温度の操作によって、多峰分布による問題を解決する方法が複数存在しています。

### 1.2.2. 焼きなまし

単純な方法としては、 $\beta=0$ でのサンプリングから初めて、徐々に $\beta \to 1$ と大きくしていく方法が考えられます。
いわゆるバーンイン（初期値付近から抜け出すまで、初期のサンプリング結果を捨てる期間）において $\beta$ を動かし、その後は $\beta=1$ に固定すれば、本来の事後分布からサンプリングできます。バーンイン期間で $0<\beta<1$ とすることで、初期値付近のmodeから脱出する効果が期待できます。
これは最適化における焼きなましそのものです。

この方法は、初期値付近の比較的小さなmodeを脱出する程度であれば、十分に機能することがほとんどです。ただしIntroに示したような多峰事後分布では、両方のmodeからサンプリングすることはできません。
逆温度を単調増加させるため、一度 $\beta=1$ としてしまえば、あとは通常のMCMCと変わらないことによります。したがって、バーンイン以降のサンプリングでは、多峰性に対処することは望めません。

[PyMCによる例1]
このように、焼きなましでは多峰分布からのサンプリングは困難であることがわかります。

### 1.2.3. レプリカ交換モンテカルロ法

多峰分布からのサンプリングを実現する方法は複数提案されていますが、その中でも代表的な手法がレプリカ交換法です。

焼きなましのように単一のMCMCサンプラー上で逆温度を操作するのではなく、複数のMCMCサンプラー（レプリカ）を走らせ、それぞれに異なる逆温度を設定します。

[逆温度交換の概念図]

図の通り、徐々に逆温度が小さく（高温）になるように配置し、隣接するサンプラーと定期的に位置を「交換」します。
直感的には、高温側（$\beta$ が小さい状態）のサンプラーでmode間の大規模遷移を行い、その遷移が「交換」によって $\beta=1$ のサンプラーに伝えられている、と言えます。

[直感的な遷移図]


# 粒子フィルタとSequential Monte Carlo

- 参考図書に樋口本を挙げておくと良い

# SMC sampler

- pymc公式ドキュメントでは参考文献を２件挙げられているが、応用寄りで
- likelihood temperingと呼ぶ向きもあり、[化学分野で応用例](https://www.sciencedirect.com/science/article/abs/pii/S0263876221003634)がある。
  - 別々に複数分野で発明されているのかも?
  - 参照を辿っていくと[ウプサラ大学の資料](https://www.it.uu.se/research/systems_and_control/education/2017/smc/schedule/lecture16_handout.pdf)に行き着く。ここでも"likelihood tempering"と呼ばれている。
    - 「Sequential Monte Carloを使ったlikelihood temperingという手法」「それらの総称が（スライドの表題でもある）SMC Sampler」とも読めるので、本記事ではそのように呼ぶことにした。

# 実行例

# 参考（になりそうな）文献
- 逆温度について
  - [『ベイズ統計の理論と方法』](https://www.amazon.co.jp/dp/4339024627/)
  - [『計算統計Ⅱ』](https://www.amazon.co.jp/dp/B078WSTYC7/)
- 粒子フィルタについて
  - 『予測にいかす統計モデリングの基本』
  - "Bayesian Filetering and Smoothing"
- SMC samplerについて
  - ["Sequential Monte Carlo methods : Lecture 16 - SMC samplers"](https://www.it.uu.se/research/systems_and_control/education/2017/smc/schedule/lecture16_handout.pdf)